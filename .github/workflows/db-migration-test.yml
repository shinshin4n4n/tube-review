name: DB Migration Test

on:
  pull_request:
    branches: [main]
    paths:
      - "supabase/migrations/**"
      - "supabase/config.toml"
      - ".github/workflows/db-migration-test.yml"
  push:
    branches: [main]
    paths:
      - "supabase/migrations/**"

jobs:
  db-migration-test:
    name: Test Migrations on Local Supabase
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Start Supabase local development
        run: |
          supabase start

      - name: Wait for Supabase to be ready
        run: |
          echo "â³ Waiting for Supabase to be ready..."
          timeout 60 bash -c 'until curl -s http://localhost:54321/rest/v1/ > /dev/null 2>&1; do sleep 2; done'
          echo "âœ… Supabase is ready"

      - name: Check Supabase status
        run: |
          supabase status

      - name: Apply all migrations
        run: |
          echo "ðŸ”„ Applying migrations..."
          supabase db reset --debug

      - name: Verify database schema
        run: |
          echo "ðŸ“‹ Checking tables..."

          # æœŸå¾…ã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªã‚¹ãƒˆ
          EXPECTED_TABLES=(
            "users"
            "channels"
            "reviews"
            "user_channels"
            "lists"
            "list_channels"
            "review_helpful"
            "user_follows"
            "user_settings"
            "top_videos"
            "youtube_cache"
            "youtube_quota_usage"
          )

          # psqlã§æŽ¥ç¶šã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
          TABLES=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT tablename FROM pg_tables WHERE schemaname = 'public';" 2>/dev/null)

          echo "Found tables:"
          echo "$TABLES"

          # å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
          MISSING_TABLES=()
          for table in "${EXPECTED_TABLES[@]}"; do
            if echo "$TABLES" | grep -q "^ $table$"; then
              echo "  âœ“ $table exists"
            else
              echo "  âŒ $table is missing"
              MISSING_TABLES+=("$table")
            fi
          done

          # æ¬ è½ã—ã¦ã„ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ãŒã‚ã‚Œã°å¤±æ•—
          if [ ${#MISSING_TABLES[@]} -gt 0 ]; then
            echo ""
            echo "âŒ Missing tables detected:"
            printf '  - %s\n' "${MISSING_TABLES[@]}"
            exit 1
          fi

          echo ""
          echo "âœ… All expected tables exist"

      - name: Verify RLS policies
        run: |
          echo "ðŸ”’ Checking RLS policies..."

          # RLSãƒãƒªã‚·ãƒ¼ã®æ•°ã‚’å–å¾—
          POLICY_COUNT=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT COUNT(*) FROM pg_policies WHERE schemaname = 'public';" 2>/dev/null | tr -d ' ')

          echo "Found $POLICY_COUNT RLS policies"

          if [ "$POLICY_COUNT" -gt 0 ]; then
            echo "âœ… RLS policies exist"

            # ãƒãƒªã‚·ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
            psql "postgresql://postgres:postgres@localhost:54322/postgres" -c "SELECT tablename, policyname, cmd FROM pg_policies WHERE schemaname = 'public' ORDER BY tablename, policyname;" 2>/dev/null || true
          else
            echo "âš ï¸ No RLS policies found (this might be intentional)"
          fi

      - name: Verify materialized views
        run: |
          echo "ðŸ“Š Checking materialized views..."

          # Materialized Viewã®å­˜åœ¨ç¢ºèª
          MV_EXISTS=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT COUNT(*) FROM pg_matviews WHERE schemaname = 'public' AND matviewname = 'channel_stats';" 2>/dev/null | tr -d ' ')

          if [ "$MV_EXISTS" = "1" ]; then
            echo "âœ… channel_stats materialized view exists"
          else
            echo "âš ï¸ channel_stats materialized view not found"
            echo "   This might be expected if it's created separately"
          fi

      - name: Verify indexes
        run: |
          echo "ðŸ” Checking indexes..."

          # ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ•°ã‚’å–å¾—
          INDEX_COUNT=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT COUNT(*) FROM pg_indexes WHERE schemaname = 'public';" 2>/dev/null | tr -d ' ')

          echo "Found $INDEX_COUNT indexes"

          if [ "$INDEX_COUNT" -gt 0 ]; then
            echo "âœ… Indexes exist"
          else
            echo "âš ï¸ No custom indexes found"
          fi

      - name: Verify functions and triggers
        run: |
          echo "âš™ï¸ Checking functions and triggers..."

          # é–¢æ•°ã®æ•°ã‚’å–å¾—
          FUNCTION_COUNT=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT COUNT(*) FROM pg_proc p JOIN pg_namespace n ON p.pronamespace = n.oid WHERE n.nspname = 'public';" 2>/dev/null | tr -d ' ')

          echo "Found $FUNCTION_COUNT custom functions"

          # ãƒˆãƒªã‚¬ãƒ¼ã®æ•°ã‚’å–å¾—
          TRIGGER_COUNT=$(psql "postgresql://postgres:postgres@localhost:54322/postgres" -t -c "SELECT COUNT(*) FROM pg_trigger WHERE tgrelid IN (SELECT oid FROM pg_class WHERE relnamespace = (SELECT oid FROM pg_namespace WHERE nspname = 'public'));" 2>/dev/null | tr -d ' ')

          echo "Found $TRIGGER_COUNT triggers"

      - name: Test migration rollback capability
        run: |
          echo "ðŸ”„ Testing migration idempotency..."

          # ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†é©ç”¨ï¼ˆå†ªç­‰æ€§ç¢ºèªï¼‰
          supabase db reset --debug

          echo "âœ… Migrations are idempotent"

      - name: Export schema for review
        if: success()
        run: |
          echo "ðŸ“¤ Exporting schema..."
          psql "postgresql://postgres:postgres@localhost:54322/postgres" -c "\d+" > schema-dump.txt 2>&1 || true

      - name: Upload schema dump
        if: success()
        uses: actions/upload-artifact@v6
        with:
          name: database-schema
          path: schema-dump.txt
          retention-days: 7

      - name: Stop Supabase
        if: always()
        run: |
          echo "ðŸ›‘ Stopping Supabase..."
          supabase stop

      - name: Upload Supabase logs
        if: failure()
        uses: actions/upload-artifact@v6
        with:
          name: supabase-logs
          path: |
            ~/.supabase/logs/
            supabase/.branches/
          retention-days: 7
